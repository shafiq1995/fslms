{# src/templates/courses/lesson_detail.html #}
{% extends "base.html" %}
{% load static %}
{% block title %}{{ lesson.title }}{% endblock %}

{% block content %}
<div class="container mt-5">
  <div class="card shadow-sm">
    <div class="card-body">
      <h3 class="fw-bold">{{ lesson.title }}</h3>
      <p class="text-muted mb-2">Course: <a href="{% url 'courses:course_detail' lesson.section.course.id %}">{{ lesson.section.course.title }}</a></p>

      {% if can_view_full %}
        <div class="mb-3">
          {% if lesson.content %}
            <div class="lesson-content">{{ lesson.content|linebreaks }}</div>
          {% else %}
            <p class="text-muted">No content for this lesson.</p>
          {% endif %}
        </div>

        {% if lesson.join_link %}
          <p>
            <a href="{{ lesson.join_link }}" target="_blank" class="btn btn-outline-primary">
              <i class="bi bi-camera-video"></i> Join Live Class
            </a>
          </p>
        {% endif %}

        <h6 class="mt-3">Attachments</h6>
        {% if lesson.attachments.all %}
          <ul class="list-group list-group-flush mt-2">
            {% for att in lesson.attachments.all %}
              <li class="list-group-item d-flex justify-content-between align-items-center">
                <span>{{ att.title|default:att.file.name }}</span>
                {% if can_view_attachments %}
                  <a href="{{ att.file.url }}" class="btn btn-sm btn-outline-primary" download><i class="bi bi-download"></i></a>
                {% else %}
                  <span class="badge bg-secondary">Locked (enroll to download)</span>
                {% endif %}
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <p class="text-muted">No attachments.</p>
        {% endif %}
      {% else %}
        <div class="alert alert-warning">
          This lesson is locked. {% if lesson.is_preview %} Preview is available. {% endif %}
        </div>
        {% if lesson.is_preview %}
          <div class="mb-3">
            <p>{{ lesson.content|truncatewords:60 }}</p>
            <a href="{% url 'courses:course_detail' lesson.section.course.id %}" class="btn btn-outline-success">Go to Course</a>
          </div>
        {% endif %}
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}
