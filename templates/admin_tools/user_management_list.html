{% extends "base.html" %}
{% load static %}
{% include "partials/header_admin.html" %}
{% block title %}User Management{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'admin_tools/css/admin.css' %}">
{% if messages %}
  <div class="container mt-3">
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }}">{{ message }}</div>
    {% endfor %}
  </div>
{% endif %}
<!--{% if messages %}-->
<!--  <div class="container mt-3">-->
<!--    {% for message in messages %}-->
<!--      <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">-->
<!--        {{ message }}-->
<!--        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>-->
<!--      </div>-->
<!--    {% endfor %}-->
<!--  </div>-->
<!--{% endif %}-->
<!--{% if messages %}-->
<!--  <div class="container mt-3">-->
<!--    {% for message in messages %}-->
<!--      <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">-->
<!--        {{ message }}-->
<!--        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>-->
<!--      </div>-->
<!--    {% endfor %}-->
<!--  </div>-->
<!--{% endif %}-->

<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="fw-bold mb-0">User Management</h3>
    <a href="{% url 'admin_tools:user_create' %}" class="btn btn-success">
      <i class="bi bi-person-plus"></i> Add New User
    </a>
  </div>

  <!-- Filters -->
<!--  <form id="filterForm" class="row g-2 align-items-end mb-4">-->
<!--    {% csrf_token %}-->
<!--    <div class="col-md-4">-->
<!--      <label class="form-label">Search</label>-->
<!--      <input type="text" id="searchInput" name="q" value="{{ query }}" class="form-control" placeholder="Search by username or email">-->
<!--    </div>-->
<!--    <div class="col-md-3">-->
<!--      <label class="form-label">Role</label>-->
<!--      <select name="role" id="roleFilter" class="form-select">-->
<!--        <option value="">All Roles</option>-->
<!--        <option value="admin" {% if role == 'admin' %}selected{% endif %}>Admin</option>-->
<!--        <option value="instructor" {% if role == 'instructor' %}selected{% endif %}>Instructor</option>-->
<!--        <option value="student" {% if role == 'student' %}selected{% endif %}>Student</option>-->
<!--      </select>-->
<!--    </div>-->
<!--    <div class="col-md-3">-->
<!--      <label class="form-label">Status</label>-->
<!--      <select name="status" id="statusFilter" class="form-select">-->
<!--        <option value="">All</option>-->
<!--        <option value="active" {% if status == 'active' %}selected{% endif %}>Active</option>-->
<!--        <option value="inactive" {% if status == 'inactive' %}selected{% endif %}>Inactive</option>-->
<!--      </select>-->
<!--    </div>-->
<!--  </form>-->
<form method="get" class="row g-2 mb-4 align-items-end">
    <div class="col-md-4">
      <label class="form-label">Search</label>
      <input type="text" name="q" value="{{ query }}" class="form-control" placeholder="Search by username or email">
    </div>

    <div class="col-md-3">
      <label class="form-label">Role</label>
      <select name="role" class="form-select">
        <option value="">All Roles</option>
        <option value="admin" {% if role == 'admin' %}selected{% endif %}>Admin</option>
        <option value="instructor" {% if role == 'instructor' %}selected{% endif %}>Instructor</option>
        <option value="student" {% if role == 'student' %}selected{% endif %}>Student</option>
      </select>
    </div>

    <div class="col-md-3">
      <label class="form-label">Status</label>
      <select name="status" class="form-select">
        <option value="">All</option>
        <option value="active" {% if status == 'active' %}selected{% endif %}>Active</option>
        <option value="inactive" {% if status == 'inactive' %}selected{% endif %}>Inactive</option>
      </select>
    </div>

    <div class="col-md-2 d-grid">
      <button type="submit" class="btn btn-primary">Filter</button>
    </div>
  </form>

  <!-- User Table (AJAX Loaded) -->
  <div id="userTableContainer">
    {% include 'admin_tools/user_table_partial.html' %}
  </div>
</div>

<!-- Create User Modal -->
<div class="modal fade" id="createUserModal" tabindex="-1" aria-labelledby="createUserModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form id="createUserForm" method="POST">
        <div class="modal-header">
          <h5 class="modal-title fw-bold" id="createUserModalLabel">Create New User</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          {% csrf_token %}
          <div class="mb-3">
            <label class="form-label">Username</label>
            <input type="text" name="username" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Email</label>
            <input type="email" name="email" class="form-control">
          </div>
          <div class="mb-3">
            <label class="form-label">Password</label>
            <input type="password" name="password" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Role</label>
            <select name="role" class="form-select" required>
              <option value="student">Student</option>
              <option value="instructor">Instructor</option>
              <option value="admin">Admin</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Create User</button>
        </div>
      </form>
    </div>
  </div>
</div>
<!-- Edit User Modal -->
<div class="modal fade" id="editUserModal" tabindex="-1" aria-labelledby="editUserModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form id="editUserForm" method="POST">
        <div class="modal-header">
          <h5 class="modal-title fw-bold" id="editUserModalLabel">Edit User</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          {% csrf_token %}
          <input type="hidden" name="user_id" id="editUserId">
          <div class="mb-3">
            <label class="form-label">Username</label>
            <input type="text" name="username" id="editUsername" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Email</label>
            <input type="email" name="email" id="editEmail" class="form-control">
          </div>
          <div class="mb-3">
            <label class="form-label">Role</label>
            <select name="role" id="editRole" class="form-select">
              <option value="student">Student</option>
              <option value="instructor">Instructor</option>
              <option value="admin">Admin</option>
            </select>
          </div>
          <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" name="is_active" id="editIsActive">
            <label class="form-check-label" for="editIsActive">Active</label>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Update User</button>
        </div>
      </form>
    </div>
  </div>
</div>


<!-- Toast -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 9999;">
  <div id="userToast" class="toast text-bg-success border-0" role="alert">
    <div class="d-flex">
      <div class="toast-body" id="toastMsg"></div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  </div>
</div>

<!-- JS -->
<script src="{% static 'admin_tools/js/user_toggle.js' %}"></script>
<script src="{% static 'admin_tools/js/user_ajax.js' %}"></script>
<script src="{% static 'admin_tools/js/user_create.js' %}"></script>
<script src="{% static 'admin_tools/js/user_edit.js' %}"></script>

{% endblock %}
