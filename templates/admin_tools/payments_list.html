{% extends "base.html" %}
{% load static %}
{% block title %}Payment Management{% endblock %}
{% include "partials/header_admin.html" %}

{% block content %}
<link rel="stylesheet" href="{% static 'payments/css/payments.css' %}">

<div class="container mt-4 mb-5">
  <h2 class="fw-bold mb-4"><i class="bi bi-cash-stack"></i> Payment Management</h2>

  <!-- Summary Cards -->
  <div class="row g-3 mb-4">
    <div class="col-md-3">
      <div class="card text-center shadow-sm border-0 p-3">
        <h6 class="text-muted">Total Payments</h6>
        <h3>{{ total_payments }}</h3>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-center shadow-sm border-0 p-3">
        <h6 class="text-muted">Pending</h6>
        <h3 class="text-warning">{{ pending_count }}</h3>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-center shadow-sm border-0 p-3">
        <h6 class="text-muted">Completed</h6>
        <h3 class="text-success">{{ completed_count }}</h3>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-center shadow-sm border-0 p-3">
        <h6 class="text-muted">Total Revenue</h6>
        <h3 class="text-primary">${{ total_revenue }}</h3>
      </div>
    </div>
  </div>

  <!-- Filters -->
  <form method="get" class="row g-2 align-items-center mb-4">
    <div class="col-md-3">
      <input type="text" name="q" value="{{ filters.q }}" class="form-control" placeholder="Search username or Tx ID">
    </div>
    <div class="col-md-2">
      <select name="status" class="form-select">
        <option value="all">All Status</option>
        <option value="Pending" {% if filters.status == "Pending" %}selected{% endif %}>Pending</option>
        <option value="Completed" {% if filters.status == "Completed" %}selected{% endif %}>Completed</option>
        <option value="Failed" {% if filters.status == "Failed" %}selected{% endif %}>Failed</option>
        <option value="Refunded" {% if filters.status == "Refunded" %}selected{% endif %}>Refunded</option>
      </select>
    </div>
    <div class="col-md-2">
      <input type="text" name="provider" value="{{ filters.provider }}" class="form-control" placeholder="Provider">
    </div>
    <div class="col-md-2">
      <input type="date" name="start_date" value="{{ filters.start }}" class="form-control">
    </div>
    <div class="col-md-2">
      <input type="date" name="end_date" value="{{ filters.end }}" class="form-control">
    </div>
    <div class="col-md-1">
      <button type="submit" class="btn btn-primary w-100"><i class="bi bi-search"></i></button>
    </div>
  </form>

  <!-- Payment Table -->
  <div class="card shadow-sm border-0">
    <div class="card-body p-0">
      <table class="table table-hover align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th>ID</th>
            <th>User</th>
            <th>Course</th>
            <th>Amount</th>
            <th>Provider</th>
            <th>Tx ID</th>
            <th>Status</th>
            <th>Date</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for p in payments %}
          <tr>
            <td>{{ p.id }}</td>
            <td>
              <strong>{{ p.user.username }}</strong><br>
              <small class="text-muted">{{ p.user.email }}</small>
            </td>
            <td>{{ p.course.title }}</td>
            <td>{{ p.amount }} à§³</td>
            <td>{{ p.get_provider_display|default:p.provider }}</td>
            <td><code>{{ p.provider_tx_id }}</code></td>
            <td>
              {% if p.status == "Pending" %}
                <span class="badge bg-warning text-dark">Pending</span>
              {% elif p.status == "Completed" %}
                <span class="badge bg-success">Completed</span>
              {% elif p.status == "Rejected" %}
                <span class="badge bg-danger">Rejected</span>
              {% elif p.status == "Refunded" %}
                <span class="badge bg-secondary">Refunded</span>
              {% else %}
                <span class="badge bg-light text-dark">{{ p.status }}</span>
              {% endif %}
            </td>
            <td>{{ p.created_at|date:"d M, Y H:i" }}</td>
            <td>
              <div class="btn-group btn-group-sm" role="group">
                {% if p.status == "Pending" %}
                  <button class="btn btn-sm btn-success" data-action="approve" data-id="{{ p.id }}">Approve</button>
                  <button class="btn btn-sm btn-danger" data-action="reject" data-id="{{ p.id }}">Reject</button>
                {% endif %}
                <button class="btn btn-sm btn-outline-secondary" data-action="refund" data-id="{{ p.id }}">Refund</button>
                <a class="btn btn-outline-primary" href="{% url 'payments:payment_invoice' p.id %}" target="_blank">
                  <i class="bi bi-receipt"></i>
                </a>
              </div>
            </td>
          </tr>
          {% empty %}
          <tr><td colspan="9" class="text-center text-muted py-4">No payments found.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    {% if page_obj %}
      <div class="card-footer text-center">
        <nav>
          <ul class="pagination justify-content-center mb-0">
            {% if page_obj.has_previous %}
              <li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}">&laquo;</a></li>
            {% else %}
              <li class="page-item disabled"><span class="page-link">&laquo;</span></li>
            {% endif %}

            <li class="page-item disabled"><span class="page-link">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span></li>

            {% if page_obj.has_next %}
              <li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}">&raquo;</a></li>
            {% else %}
              <li class="page-item disabled"><span class="page-link">&raquo;</span></li>
            {% endif %}
          </ul>
        </nav>
      </div>
    {% endif %}
  </div>
</div>

<!-- Action Modal -->
<div class="modal fade" id="actionModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="actionForm">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title">Admin Action</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="paymentId">
          <input type="hidden" id="actionType">
          <div class="mb-3">
            <label for="note" class="form-label">Admin Note (optional)</label>
            <textarea id="note" class="form-control" rows="3"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Submit</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Toast Notifications -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1100">
  <div id="alertToast" class="toast text-bg-success" role="alert">
    <div class="toast-body" id="toastMessage"></div>
  </div>
</div>

<script>
  const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || (document.cookie.match(/csrftoken=([^;]+)/)||[])[1];
  const headers = {'X-CSRFToken': csrftoken, 'X-Requested-With': 'XMLHttpRequest'};
  function handleAction(id, action) {
    let url = "";
    if (action === "approve") url = "{% url 'payments:approve_payment' 0 %}".replace('/0/', `/${id}/`);
    if (action === "reject") url = "{% url 'payments:reject_payment' 0 %}".replace('/0/', `/${id}/`);
    if (action === "refund") url = "{% url 'payments:refund_payment' 0 %}".replace('/0/', `/${id}/`);
    fetch(url, {method: "POST", headers})
      .then(r => r.json())
      .then(data => {
        if (data.success) {
          location.reload();
        } else {
          alert(data.message || "Action failed");
        }
      })
      .catch(() => alert("Network error"));
  }
  document.querySelectorAll("[data-action]").forEach(btn => {
    btn.addEventListener("click", (e) => {
      e.preventDefault();
      const id = btn.getAttribute("data-id");
      const action = btn.getAttribute("data-action");
      handleAction(id, action);
    });
  });
</script>
{% endblock %}
