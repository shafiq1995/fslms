{% extends "base.html" %}
{% block title %}Set New Password - Online Learning Platform{% endblock %}
{% block content %}

<div class="container-fluid py-5 bg-light">
  <div class="row justify-content-center">
    <div class="col-md-8 col-lg-6 col-xl-5">
      <div class="card shadow-lg border-0 rounded-4 overflow-hidden">
        <div class="card-body p-5">

          <!-- Header Section -->
          <div class="text-center mb-4">
            <div class="bg-primary bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 80px; height: 80px;">
              <i class="bi bi-shield-lock display-5 text-primary"></i>
            </div>
            <h2 class="fw-bold text-dark mb-2">Set New Password</h2>
            <p class="text-muted">Create a strong, secure password for your account</p>
          </div>

          <!-- Password Requirements -->
          <div class="alert alert-info border-0 bg-light mb-4">
            <div class="d-flex">
              <i class="bi bi-info-circle text-primary me-3 mt-1"></i>
              <div>
                <h6 class="fw-semibold text-dark mb-2">Password Requirements</h6>
                <ul class="list-unstyled text-muted small mb-0">
                  <li class="mb-1"><i class="bi bi-check-circle text-success me-2"></i>At least 8 characters long</li>
                  <li class="mb-1"><i class="bi bi-check-circle text-success me-2"></i>Include both uppercase and lowercase letters</li>
                  <li class="mb-1"><i class="bi bi-check-circle text-success me-2"></i>Contain at least one number</li>
                  <li><i class="bi bi-check-circle text-success me-2"></i>Include at least one special character</li>
                </ul>
              </div>
            </div>
          </div>

          <!-- Password Reset Form -->
          <form method="post">
            {% csrf_token %}

            <!-- Display non-field errors -->
            {% if form.non_field_errors %}
              <div class="alert alert-danger d-flex align-items-center" role="alert">
                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                <div>
                  {% for error in form.non_field_errors %}
                    {{ error }}
                  {% endfor %}
                </div>
              </div>
            {% endif %}

            <!-- New Password 1 Field -->
            <div class="mb-4">
              <label for="{{ form.new_password1.id_for_label }}" class="form-label fw-medium text-dark">
                <i class="bi bi-key me-2"></i>New Password
              </label>
              <div class="input-group">
                {{ form.new_password1 }}
                <button class="btn btn-outline-secondary toggle-password" type="button" data-target="{{ form.new_password1.id_for_label }}">
                  <i class="bi bi-eye"></i>
                </button>
              </div>
              {% if form.new_password1.errors %}
                <div class="text-danger small mt-2">
                  {% for error in form.new_password1.errors %}
                    <i class="bi bi-exclamation-circle me-1"></i>{{ error }}
                  {% endfor %}
                </div>
              {% endif %}
              <!-- Password Strength Meter -->
              <div class="mt-2">
                <div class="progress" style="height: 5px;">
                  <div id="password-strength-bar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                </div>
                <small id="password-strength-text" class="text-muted">Password strength</small>
              </div>
            </div>

            <!-- New Password 2 Field -->
            <div class="mb-4">
              <label for="{{ form.new_password2.id_for_label }}" class="form-label fw-medium text-dark">
                <i class="bi bi-key-fill me-2"></i>Confirm New Password
              </label>
              <div class="input-group">
                {{ form.new_password2 }}
                <button class="btn btn-outline-secondary toggle-password" type="button" data-target="{{ form.new_password2.id_for_label }}">
                  <i class="bi bi-eye"></i>
                </button>
              </div>
              {% if form.new_password2.errors %}
                <div class="text-danger small mt-2">
                  {% for error in form.new_password2.errors %}
                    <i class="bi bi-exclamation-circle me-1"></i>{{ error }}
                  {% endfor %}
                </div>
              {% endif %}
              <!-- Password Match Indicator -->
              <div class="mt-2">
                <small id="password-match-text" class="text-muted">Passwords must match</small>
              </div>
            </div>

            <!-- Submit Button -->
            <button type="submit" class="btn btn-success w-100 py-2 fw-medium rounded-pill mb-3">
              <i class="bi bi-check-circle me-2"></i>Update Password
            </button>

          </form>

          <!-- Back to Login -->
          <div class="text-center mt-4 pt-3 border-top">
            <p class="text-muted mb-0">
              Remember your password?
              <a href="{% url 'accounts:login' %}" class="text-primary fw-medium text-decoration-none">Back to Login</a>
            </p>
          </div>

        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .card {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }

  .card:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 30px rgba(0,0,0,0.1) !important;
  }

  .btn-success {
    background: linear-gradient(135deg, #198754, #20c997);
    border: none;
  }

  .btn-success:hover {
    background: linear-gradient(135deg, #157347, #1ba87e);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(25, 135, 84, 0.3);
  }

  /* Style the Django form inputs */
  #{{ form.new_password1.id_for_label }},
  #{{ form.new_password2.id_for_label }} {
    border: 1px solid #ced4da;
    border-right: none;
    border-radius: 0.375rem 0 0 0.375rem;
    padding: 0.75rem;
    flex: 1;
    transition: all 0.3s ease;
  }

  #{{ form.new_password1.id_for_label }}:focus,
  #{{ form.new_password2.id_for_label }}:focus {
    outline: none;
    box-shadow: none;
    border-color: #198754;
  }

  .toggle-password {
    border: 1px solid #ced4da;
    border-left: none;
    border-radius: 0 0.375rem 0.375rem 0;
  }

  .progress {
    background-color: #e9ecef;
  }

  /* Ensure labels are styled properly */
  label {
    font-weight: 500;
    color: #212529;
    margin-bottom: 0.5rem;
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Password visibility toggle
    const toggleButtons = document.querySelectorAll('.toggle-password');
    toggleButtons.forEach(button => {
      button.addEventListener('click', function() {
        const targetId = this.getAttribute('data-target');
        const passwordInput = document.getElementById(targetId);
        const icon = this.querySelector('i');

        if (passwordInput.type === 'password') {
          passwordInput.type = 'text';
          icon.classList.remove('bi-eye');
          icon.classList.add('bi-eye-slash');
        } else {
          passwordInput.type = 'password';
          icon.classList.remove('bi-eye-slash');
          icon.classList.add('bi-eye');
        }
      });
    });

    // Password strength indicator
    const passwordInput1 = document.getElementById('{{ form.new_password1.id_for_label }}');
    const strengthBar = document.getElementById('password-strength-bar');
    const strengthText = document.getElementById('password-strength-text');

    if (passwordInput1 && strengthBar && strengthText) {
      passwordInput1.addEventListener('input', function() {
        const password = this.value;
        let strength = 0;
        let text = 'Password strength';
        let color = '#6c757d';

        // Check password length
        if (password.length >= 8) strength += 25;

        // Check for uppercase and lowercase letters
        if (/[a-z]/.test(password) && /[A-Z]/.test(password)) strength += 25;

        // Check for numbers
        if (/[0-9]/.test(password)) strength += 25;

        // Check for special characters
        if (/[^A-Za-z0-9]/.test(password)) strength += 25;

        // Update strength bar and text
        strengthBar.style.width = strength + '%';

        if (strength < 50) {
          color = '#dc3545';
          text = 'Weak password';
        } else if (strength < 75) {
          color = '#fd7e14';
          text = 'Medium password';
        } else {
          color = '#198754';
          text = 'Strong password';
        }

        strengthBar.style.backgroundColor = color;
        strengthText.textContent = text;
        strengthText.style.color = color;
      });
    }

    // Password match indicator
    const passwordInput2 = document.getElementById('{{ form.new_password2.id_for_label }}');
    const matchText = document.getElementById('password-match-text');

    if (passwordInput1 && passwordInput2 && matchText) {
      function checkPasswordMatch() {
        if (passwordInput2.value === '') {
          matchText.textContent = 'Passwords must match';
          matchText.style.color = '#6c757d';
        } else if (passwordInput1.value === passwordInput2.value) {
          matchText.innerHTML = '<i class="bi bi-check-circle text-success me-1"></i>Passwords match';
          matchText.style.color = '#198754';
        } else {
          matchText.innerHTML = '<i class="bi bi-x-circle text-danger me-1"></i>Passwords do not match';
          matchText.style.color = '#dc3545';
        }
      }

      passwordInput1.addEventListener('input', checkPasswordMatch);
      passwordInput2.addEventListener('input', checkPasswordMatch);
    }
  });
</script>

{% endblock %}
